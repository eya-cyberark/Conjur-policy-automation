name: Authenticate and Fetch Secret from Conjur

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull requests to the main branch

jobs:
  authenticate_and_fetch_secret:
    runs-on: ubuntu-latest  # Use Ubuntu runner

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2  # Checkout code

    - name: Install curl
      run: |
        sudo apt-get update
        sudo apt-get install -y curl  # Install curl for API calls

    - name: Authenticate to Conjur and Get Token
      id: authenticate
      run: |
        # Run the curl command to authenticate to Conjur and get the token
        response=$(curl --header "Accept-Encoding: base64" --data 3hyc3sp22ayr0y1qpxsn3237wvg3224bz153jr30fm22bd6p41cb9tx5 \
          --write-out "%{http_code}" \
          --output response.txt \
          https://sme-andrew.secretsmgr.cyberark.cloud/api/authn/conjur/host%2Fdata%2Feyatest1/authenticate)

        status_code=$(echo "$response" | tail -n 1)
        
        if [ "$status_code" -eq 200 ]; then
          # If authentication is successful, store the token
          echo "Successfully authenticated. Token: $(cat response.txt)"
          echo "auth_token=$(cat response.txt)" >> $GITHUB_ENV
        else
          echo "Token has expired or authentication failed. Status Code: $status_code"
          exit 1
        fi

    - name: Display the Authentication Token
      run: |
        echo "Successfully authenticated. Token: ${{ env.auth_token }}"
        echo "Done"

    - name: Load Policy to Conjur
      run: |
        # Use the auth_token to load policy into Conjur
        curl -v --request POST \
          --url https://sme-andrew.secretsmgr.cyberark.cloud/api/policies/conjur/policy/data/app-secrets/test \
          --header "Authorization: Token token=eyJwcm90ZWN0ZWQiOiJleUpoYkdjaU9pSmpiMjVxZFhJdWIzSm5MM05zYjNOcGJHOHZkaklpTENKcmFXUWlPaUl6Wm1NNE1qYzJabUkyWWpZNE1HUXpZMlV6WkdJM05XSXdabVkzWW1RME5qWmlZMlUwTlRRMlpHWTFaRGN6TTJaaVptTTRPRGN5WXpnMVlqYzNZamRrSW4wPSIsInBheWxvYWQiOiJleUpwWVhRaU9qRTNOREV6TURNME9UTXNJbk4xWWlJNkltaHZjM1F2WkdGMFlTOWxlV0YwWlhOME1TSXNJbVY0Y0NJNk1UYzBNVE13TXprM015d2lkR2xrSWpvaVpESXpOMlptTVdVdFpXVXpaUzAwTURRNExXRXpNV1V0T0RFeE1EZ3dObU14WWpkakluMD0iLCJzaWduYXR1cmUiOiJ0bU9McEF4d2xTYU9SbG9CaFZtMVVHSzBMR0hEelJzeUJYRkhDdldWRThnUGhVVFFqSzFfR2tXMmZBVld1RmdCb2tFV05GTlVodnRwNTBON1Zpa2F3emIxdUpxREFHZUlERkVNN0t0OWNMTWl6M1JIUEVtNzJfZjZNb0lyV3l3NnV5LS1KQXIwQk9QYnBiWmtSWTlGRzViM05oN0E3cWpYOE1HTEx1MmUxblZ6dXBIU0Rsa1ZzUmVsT1FqMjI3THVTUG1mM1lMTnRUNGpZQl9kVEpiSXNBN1pWZFZuejlNc1kzTXFkUlp6Q1A2QXctai1uX0o2anJOVDAxdExjTEZ4NjR1cmpZY25FenR2cUdxQ3hEUU8yVWY5SHI0NVM5enZkS2QzNnBtYXUtRGN5ZHNXcnNJWTRka2RHZ2U1X0IwaDhBRmtrbTV3Q1hrU1FEWWJ4VlMtZFE3QlBibXMwN0VsVlNPZE5jN2RkRmp2YUpiMVJYNHlHY19jdTVfNlc2QXEifQ==" \
          --header "Content-Type: text/plain" \
          --data '- !variable
                   id: testGitHub'
