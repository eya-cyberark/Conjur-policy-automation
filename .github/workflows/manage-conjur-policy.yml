name: Test GitHub OIDC Token

on:
  workflow_dispatch:  # Allows you to run this manually from the Actions tab

permissions:
  id-token: write
  contents: read

jobs:
  get-jwt-token:
    runs-on: ubuntu-latest
    steps:
      - name: Print environment variables
        run: |
          echo "Request URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "Request Token: $ACTIONS_ID_TOKEN_REQUEST_TOKEN"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Request OIDC token from GitHub
        run: |
          echo "Requesting GitHub OIDC token..."
          token_response=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}?audience=conjur")

          echo "Raw response from GitHub OIDC:"
          echo "$token_response"

          jwt_token=$(echo "$token_response" | jq -r '.value')

          if [ "$jwt_token" = "null" ] || [ -z "$jwt_token" ]; then
            echo "❌ Failed to retrieve JWT token from GitHub OIDC"
            exit 1
          fi

          echo "✅ Successfully retrieved JWT token:"
          echo "$jwt_token"