name: Authenticate and Fetch Secret from Conjur

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  authenticate_and_fetch_secret:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq git

    #############################################
    # ðŸ” Request GitHub OIDC Token
    #############################################
    - name: Request GitHub OIDC token
      id: request_token
      run: |
        echo "Requesting GitHub OIDC token..."
        token_response=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "${ACTIONS_ID_TOKEN_REQUEST_URL}?audience=conjur")

        echo "Raw token response: $token_response"
        
        jwt_token=$(echo "$token_response" | jq -r '.value')
        
        if [ "$jwt_token" = "null" ] || [ -z "$jwt_token" ]; then
          echo "Failed to retrieve JWT token from GitHub OIDC"
          exit 1
        fi

        echo "jwt_token=$jwt_token" >> $GITHUB_OUTPUT

    #############################################
    # ðŸ§ª Authenticate to Conjur Using API Key
    #############################################
    - name: Authenticate to Conjur
      id: authenticate
      run: |
        response=$(curl --header "Accept-Encoding: base64" \
          --data ${{ secrets.CONJUR_API_KEY }} \
          --write-out "%{http_code}" \
          --output response.txt \
          https://sme-andrew.secretsmgr.cyberark.cloud/api/authn/conjur/host%2Fdata%2Fapp-secrets%2Feyatest1/authenticate)

        status_code=$(echo "$response" | tail -n 1)

        if [ "$status_code" -eq 200 ]; then
          echo "Successfully authenticated."
          echo "auth_token=$(cat response.txt)" >> $GITHUB_ENV
        else
          echo "Authentication failed. Status Code: $status_code"
          exit 1
        fi

    - name: Display Auth Token (for debug)
      run: echo "Auth Token: ${{ env.auth_token }}"

    #############################################
    # ðŸ“œ Load Policy to Conjur
    #############################################
    - name: Load Policy to Conjur
      run: |
        files=$(git diff-tree --no-commit-id --name-only -r ${GITHUB_SHA})
        for file in $files; do
          if [[ "$file" == "*/workflows/*.yml" ]]; then
            echo "Skipping pipeline file: $file"
          elif [ -f "$file" ]; then
            if [[ "$file" == *github/*01_*.yml ]]; then
              echo "Loading policy file: $file"
              curl -v --request POST \
                --url https://sme-andrew.secretsmgr.cyberark.cloud/api/policies/conjur/policy/data/app-secrets/test \
                --header "Authorization: Token token=\"${{ env.auth_token }}\"" \
                --header "Content-Type: text/plain" \
                --data-binary @"$file"
            fi
          fi
        done
